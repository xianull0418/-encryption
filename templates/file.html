<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件加密解密</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/file.css') }}">
</head>
<body>
    <div class="nav">
        <a href="/text">文本加密解密</a>
        <a href="/file">文件加密解密</a>
    </div>
    
    <h1>文件加密与解密工具</h1>
    
    <div class="section">
        <h2>文件加密</h2>
        <form id="encrypt-file-form" onsubmit="handleFileEncrypt(event)">
            <div class="file-upload">
                <label for="encrypt-file">点击或拖拽文件到此处上传（支持多文件）</label>
                <input id="encrypt-file" type="file" name="file" multiple accept=".docx,.pptx,.ppt,.pdf">
            </div>
            <div id="encrypt-file-list" class="file-list"></div>
            <input type="text" name="secret" placeholder="输入要隐藏的信息">
            <button type="submit">加密文件</button>
        </form>
    </div>
    
    <div class="section">
        <h2>文件解密</h2>
        <form id="decrypt-file-form" onsubmit="handleFileDecrypt(event)">
            <div class="file-upload">
                <label for="decrypt-file">点击或拖拽文件到此处上传（支持多文件）</label>
                <input id="decrypt-file" type="file" name="file" multiple accept=".docx,.pptx,.ppt,.pdf">
            </div>
            <div id="decrypt-file-list" class="file-list"></div>
            <button type="submit">解密文件</button>
        </form>
    </div>
    
    <div id="result-section" class="section" style="display: none;">
        <h3>操作结果 (<span id="action-type"></span>):</h3>
        <div class="result-area">
            <textarea id="result-area" rows="4" cols="50" readonly></textarea>
        </div>
    </div>

    <script>
    // 文件列表管理
    function updateFileList(files, listId) {
        const fileList = document.getElementById(listId);
        fileList.innerHTML = '';
        
        Array.from(files).forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <span class="file-name">${file.name}</span>
                <span class="file-remove" onclick="removeFile(${index}, '${listId}')">&times;</span>
            `;
            fileList.appendChild(fileItem);
        });
    }

    function removeFile(index, listId) {
        const input = document.querySelector(`#${listId.replace('-list', '')}`);
        const dt = new DataTransfer();
        const files = Array.from(input.files);
        files.splice(index, 1);
        files.forEach(file => dt.items.add(file));
        input.files = dt.files;
        updateFileList(input.files, listId);
    }

    // 文件上传处理
    document.getElementById('encrypt-file').addEventListener('change', function(e) {
        updateFileList(this.files, 'encrypt-file-list');
    });

    document.getElementById('decrypt-file').addEventListener('change', function(e) {
        updateFileList(this.files, 'decrypt-file-list');
    });

    async function handleFileEncrypt(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        
        try {
            const response = await fetch('/encrypt_file', {
                method: 'POST',
                body: formData
            });
            
            // 检查是否是文件下载响应
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/octet-stream')) {
                // 处理文件下载
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = response.headers.get('content-disposition')?.split('filename=')[1] || 'encrypted_file';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
                showResult('文件加密成功，已开始下载', '加密');
            } else {
                // 处理错误信息
                const data = await response.json();
                showResult(data.result, data.action);
            }
        } catch (error) {
            showResult('操作失败: ' + error.message, '错误');
        }
    }

    async function handleFileDecrypt(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        
        try {
            const response = await fetch('/decrypt_file', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            showResult(data.result, data.action);
        } catch (error) {
            showResult('操作失败: ' + error.message, '错误');
        }
    }

    function showResult(result, action) {
        const resultSection = document.getElementById('result-section');
        const actionType = document.getElementById('action-type');
        const resultArea = document.getElementById('result-area');
        
        resultSection.style.display = 'block';
        actionType.textContent = action;
        resultArea.value = result;
    }

    // 添加文件拖放功能
    function setupFileDrop(inputId) {
        const dropZone = document.querySelector(`label[for="${inputId}"]`);
        const input = document.getElementById(inputId);

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            dropZone.classList.add('highlight');
        }

        function unhighlight(e) {
            dropZone.classList.remove('highlight');
        }

        dropZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            input.files = files;
        }
    }

    // 初始化文件拖放
    setupFileDrop('encrypt-file');
    setupFileDrop('decrypt-file');
    </script>
</body>
</html> 